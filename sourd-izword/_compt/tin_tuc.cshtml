@inherits MyWebPage
@using SLK.Common
@functions {
    [Component(
        Type = ComptType.Page_Template,
        PathPostfix = "/{0}",
        ComptName = "en:Blog list template|vi:Mẫu trang danh sách tin tức",
        PageType = "list", NodeType = "post")]
    public class ViewModel : PageListModel
    {
        public VM_Blog[] Itemblog { get; set; }

        public VM_Blog[] BlogSearch { get; set; }

        [Field(
   Title = "en:Title banner|vi:Tiêu đề banner",
   Required = false,
   Control = InputControlType.TextBox)]
        public string TitleBanner { get; set; }


        [Field(
      Title = "en:Title widget adds|vi:Tiêu đề tiện ích bổ sung",
      Required = false,
      Control = InputControlType.TextBox)]
        public string TitleWidget { get; set; }

        [Field(
      Title = "en:Link widget adds|vi:Đường dẫn tiện ích",
      Required = false,
      Control = InputControlType.Link)]
        public string HrefWidget { get; set; }

        public static ViewModel Default => new ViewModel()
        {

        };
    }/*end_viewmodel*/
    private ViewModel _data;
    private ViewModel Data => _data ?? (_data = ViewModel.Default);
    private MyTranslator Text => new MyTranslator(Data?.Phrases);
}
@{
    string keyword = Request.QueryString[nameof(keyword)];
    var slug = ToneRemover.MakeSlug(keyword);

    _data = LoadData<ViewModel>(key: $"{LangId}-{FileName}#{NodeSlug}", setup: (model) =>
    {
        model = model ?? new ViewModel();

        var page = Db.GetOne<PP_Page>(PageId);
        if (page == null) return null;

        var category = Db.GetOne<PP_Category>(t => t.CategoryPath == NodeSlug);
        if (category == null) return null;

        model.Breadcrumbs = Newtonsoft.Json.JsonConvert.DeserializeObject<KeyValuePair<string, string>[]>(category.Breadcrumb);
        var arrCategory = Root.CategoryIndexes[category.Id].ToList();

        model.Itemblog =
           (from node in Db.Table<PP_Node>()
            join cat in Db.Table<PP_Category>() on node.CategoryId equals cat.Id
            where node.NodeType == "post" && arrCategory.Contains(node.CategoryId ?? 0)
            select new VM_Blog
            {
                JsonContent = node.Content,
                Title = node.Title,
                Path = node.NodePath,
                Summary = node.Summary,
                ImageUrl = node.ImageUrl,
                CreatedTime = node.CreatedTime,
                CategoryName = cat.Title,
                CategoryPath = cat.CategoryPath,
            }).OrderByDescending(t => t.CreatedTime).ToArray();

        if (!string.IsNullOrEmpty(slug))
        {
            model.BlogSearch = (from node in Db.Table<PP_Node>()
                                join cat in Db.Table<PP_Category>() on node.CategoryId equals cat.Id
                                where node.NodeType == "post" && arrCategory.Contains(node.CategoryId ?? 0) && (node.NodePath.Contains(slug))
                                select new VM_Blog
                                {
                                    JsonContent = node.Content,
                                    Title = node.Title,
                                    Path = node.NodePath,
                                    Summary = node.Summary,
                                    ImageUrl = node.ImageUrl,
                                    CreatedTime = node.CreatedTime,
                                    CategoryId = cat.Id,
                                    CategoryName = cat.Title,
                                    CategoryPath = cat.CategoryPath
                                }).OrderByDescending(t => t.CreatedTime).ToArray();
        }
        else
        {
            model.BlogSearch = model.Itemblog.ToArray();
        }

        var paging = model.BlogSearch
           .OrderByDescending(t => t.CreatedTime)
           .Skip((this.CurrentPage - 1) * 3)
           .Take(3)
           .GroupBy(p => new { Total = model.BlogSearch.Count() })
           .FirstOrDefault();

        if (paging != null)
        {
            model.TotalPages = (long)Math.Ceiling((decimal)paging.Key.Total / 3);
            model.BlogSearch = paging.ToArray();
        }
        else
        {
            model.TotalPages = 1;
            model.BlogSearch = new VM_Blog[] { };
        }


        model.Title = page.Title;
        model.Banner = category.ImageUrl;
        model.MetaDescription = page.MetaDescription;
        model.MetaKeywords = page.MetaKeywords;
        model.CurrentPage = this.CurrentPage;
        //model.CategoryPath = category.CategoryPath;

        foreach (var item in model.BlogSearch)
        {
            var json = Json.Decode<VM_Blog>(item.JsonContent);
            item.HrefShare = json.HrefShare;
            item.Author = json.Author;
        }

        return model;
    });

    Layout = $"~/_layouts/_layout.cshtml";
    Page.Title = Data.Title;
    Page.Description = Data.MetaDescription;
    Page.Keywords = Data.MetaKeywords;
}
<!-- Start Page Title area-->
<div class="page-title-area" style="background-image: url(@Data.Banner)">
    <div class="container">
        <div class="content text-center">
            <h1 class="title_banner">@Data.TitleBanner</h1>
            <ul class="list-unstyled">
                <li class="d-inline"><a href="/">Trang chủ</a></li>
                @foreach (var bc in Data.Breadcrumbs.EmptyIfNull().Select((x, y) => new { x, y }))
                {
                    if (bc.y + 1 == Data.Breadcrumbs.Count())
                    {
                        <li class="d-inline">/</li>
                        <li class="d-inline">@bc.x.Value</li>
                    }
                    else
                    {
                        <li class="d-inline">/</li>
                        <li class="d-inline"><a href="@bc.x.Key">@bc.x.Value</a></li>
                    }
                }
            </ul>
        </div>
    </div>
</div>
<!-- End Page Title area -->
<!-- Start Blog Area -->
<div class="blog-area blog-with-sidebar pt-120 pb-90">
    <div class="container">
        <div class="row justify-content-center gx-xl-5">
            <div class="col-lg-8">
                @if (!string.IsNullOrEmpty(keyword) && Data.BlogSearch.Count() == 0)
                {
                    <div class="w-100 search_null">
                        Rất tiếc, chúng tôi không tìm thấy kết quả với từ khóa <span class="text-danger">"@keyword"</span> bạn cần!.
                    </div>
                }               
                @if(string.IsNullOrEmpty(keyword) && Data.BlogSearch.Count() == 0)
                {
                    <h5>Đang cập nhật...</h5>
                }
                @foreach (var item in Data.BlogSearch.EmptyIfNull())
                {
                    <article class="item-single mb-30">
                        <div class="image">
                            <a href="@item.Path" class="lazy-container aspect-ratio">
                                <img class="lazyload lazy-image" src="@item.ImageUrl" data-src="@item.ImageUrl" alt="image">
                            </a>
                            <a href="@item.HrefShare" class="btn primary-btn primary-btn-2"><i class="fas fa-share-alt"></i>Chia sẻ</a>
                        </div>
                        <div class="content">
                            <ul class="info-list">
                                <li><i class="far fa-calendar-alt"></i>@item.CreatedTime.ToString("d")</li>
                                <li><i class="fas fa-user"></i>@item.Author</li>
                                <li><i class="fas fa-tag"></i><a href="@item.CategoryPath">@item.CategoryName</a></li>
                            </ul>
                            <h3 class="title">
                                <a href="@item.Path">
                                    @item.Title
                                </a>
                            </h3>
                            <p>
                                @item.Summary
                            </p>
                            <a href="@item.Path" class="btn primary-btn primary-btn-5">Đọc tiếp</a>
                        </div>
                    </article>
                }                
                <div class="pagination mb-30 @((!string.IsNullOrEmpty(keyword) || Data.BlogSearch.Count() == 0) ? "d-none" : "")">
                    @if (Data.CurrentPage > 1)
                    {
                        <a href="/@Data.CategoryPath?page=@(Data.CurrentPage - 1)" class="page-numbers"><i class="fas fa-angle-left"></i></a>
                    }
                    @for (int idx = 1; idx <= Data.TotalPages; idx++)
                    {
                        if (idx == Data.CurrentPage)
                        {
                            <span class="page-numbers current" aria-current="page">@idx</span>
                        }
                        else
                        {
                            <a href="/@Data.CategoryPath?page=@(idx)" class="page-numbers">@idx</a>
                        }
                    }
                    @if (Data.CurrentPage < Data.TotalPages)
                    {
                        <a href="/@Data.CategoryPath?page=@(Data.CurrentPage + 1)" class="page-numbers"><i class="fas fa-angle-right"></i></a>
                    }
                </div>
            </div>
            <div class="col-lg-4">
                <aside class="sidebar-widget-area">
                    <div class="widget widget-search mb-30">
                        <h3 class="title">Tìm kiếm bài viết</h3>
                        <form class="search-form" action="/@NodeSlug" method="get">
                            @AntiForgery.GetHtml()
                            <input type="search" name="keyword" value="@Request.QueryString["keyword"]" class="search-input" placeholder="Tìm kiếm..">
                            <button class="btn-search" type="submit" value="Search">
                                <i class="far fa-search"></i>
                            </button>
                        </form>
                    </div>
                    <div class="widget widget-social-link mb-30">
                        <h3 class="title">Theo dõi chúng tôi</h3>
                        <ul class="list-unstyled m-0">
                            <li class="d-inline">
                                <a href="@Root.Config.LinkFacebook" target="_blank" class="facebook"><i class="fab fa-facebook-square"></i></a>
                            </li>
                            <li class="d-inline ms-1">
                                <a href="@Root.Config.LinkTwitter" target="_blank" class="twitter"><i class="fab fa-twitter-square"></i></a>
                            </li>
                            <li class="d-inline ms-1">
                                <a href="@Root.Config.LinkGoogle" target="_blank" class="google"><i class="fab fa-google-plus-square"></i></a>
                            </li>
                            <li class="d-inline ms-1">
                                <a href="@Root.Config.Linkedin" target="_blank" class="linkedin"><i class="fab fa-linkedin"></i></a>
                            </li>
                        </ul>
                    </div>
                    <div class="widget widget-post mb-30">
                        <h3 class="title">Bài viết gần đây</h3>
                        @if(Data.Itemblog.Count() == 0)
                        {
                            <h5>Đang cập nhật...</h5>
                        }
                        @foreach (var item in Data.Itemblog.EmptyIfNull().Take(5))
                        {
                            <article class="article-item mb-30">
                                <div class="image">
                                    <a href="@item.Path" class="lazy-container aspect-ratio">
                                        <img class="lazyload lazy-image" src="@item.ImageUrl" data-src="@item.ImageUrl" alt="image">
                                    </a>
                                </div>
                                <div class="content">
                                    <h6>
                                        <a href="@item.Path">@item.Title</a>
                                    </h6>
                                    <div class="time">
                                        @item.CreatedTime.ToString("dd/MM/yyyy")
                                    </div>
                                </div>
                            </article>
                        }
                    </div>

                    <div class="widget widget-adds mb-30">
                        <div class="content text-center">
                            <h3>@Data.TitleWidget"</h3>
                            <a href="@Data.HrefWidget" class="btn secondary-btn text-uppercase">Bắt đầu</a>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>
</div>
<!-- End Blog Area -->