@inherits MyWebPage
@using SLK.Common
@functions {
    [Component(
        Type = ComptType.Page_Template,
        PathPostfix = "/{0}",
        ComptName = "en:Service list template|vi:Mẫu trang danh sách tính năng",
        PageType = "list", NodeType = "post")]
    public class ViewModel : PageListModel
    {
        [Field(
            Title = "en:Tiêu đề banner|vi:Tiêu đề banner",
            Required = false,
            Control = InputControlType.TextBox)]
        public string TitleBanner { get; set; }       

        public VM_Service[] Services { get; set; }

        public static ViewModel Default => new ViewModel()
        {
            Title = "Tính năng của chúng tôi"
        };
    }/*end_viewmodel*/
    private ViewModel _data;
    private ViewModel Data => _data ?? (_data = ViewModel.Default);
    private MyTranslator Text => new MyTranslator(Data?.Phrases);
}
@{
    _data = LoadData<ViewModel>(key: $"{LangId}-{FileName}#{NodeSlug}", setup: (model) =>
    {
        model = model ?? ViewModel.Default;

        var page = Db.GetOne<PP_Page>(PageId);

        if (page == null)
        {
            return model;
        }

        var category = Db.GetOne<PP_Category>(t => t.CategoryPath == NodeSlug);
        if (category == null) return null;

        model.Breadcrumbs = Newtonsoft.Json.JsonConvert.DeserializeObject<KeyValuePair<string, string>[]>(category.Breadcrumb);

        var arrCate = Root.CategoryIndexes[category.Id].ToList();

        model.Services = (from n in Db.Table<PP_Node>()
                          join cat in Db.Table<PP_Category>() on n.CategoryId equals cat.Id
                          where n.NodeType == "post" && arrCate.Contains(n.CategoryId ?? 0)
                          select new VM_Service
                          {
                              Title = n.Title,
                              ImageUrl = n.ImageUrl,
                              Summary = n.Summary,
                              JsonContent = n.Content,
                              CreatedTime = n.CreatedTime,
                              CategoryName = cat.Title,
                              CategoryPath = cat.CategoryPath,
                              Path = n.NodePath,
                          }).ToArray();

        var paging = model.Services
                    .OrderByDescending(x => x.CreatedTime)
                    .Skip((this.CurrentPage - 1) * 6)
                    .Take(6)
                    .GroupBy(x => new { Total = model.Services.Count() })
                    .FirstOrDefault();

        if (paging != null)
        {
            model.TotalPages = (long)Math.Ceiling((decimal)paging.Key.Total / 6);
            model.Services = paging.ToArray();
        }
        else
        {
            model.TotalPages = 1;
            model.Services = new VM_Service[] { };
        }

        model.Title = page.Title;
        model.MetaDescription = page.MetaDescription;
        model.MetaKeywords = page.MetaKeywords;
        model.Banner = category.ImageUrl;
        model.CurrentPage = this.CurrentPage;
        model.CategoryPath = category.CategoryPath;

        return model;
    });

    Layout = $"~/_layouts/_layout.cshtml";
    Page.Title = Data.Title;
    Page.Description = Data.MetaDescription;
    Page.Keywords = Data.MetaKeywords;
}

<!-- Start Page Title area-->
<div class="page-title-area" style="background-image: url(@Data.Banner);">
    <div class="container">
        <div class="content text-center">
            <h1 class="title_banner">@Data.TitleBanner</h1>
            <ul class="list-unstyled">
                <li class="d-inline"><a href="/">Trang chủ</a></li>
                @foreach (var item in Data.Breadcrumbs.EmptyIfNull().Select((x, y) => new { x, y }))
                {
                    if (item.y + 1 == Data.Breadcrumbs.Count())
                    {
                        <li class="d-inline">/</li>
                        <li class="d-inline active">@item.x.Value</li>
                    }
                    else
                    {
                        <li class="d-inline">/</li>
                        <li class="d-inline active"><a href="@item.x.Key">@item.x.Value</a></li>
                    }
                }
            </ul>
        </div>
    </div>
</div>
<!-- End Page Title area -->
    
<!-- Start Services Area -->
<section class="services-area services-2 ptb-120">
    <div class="container">
        <div class="row justify-content-center">
            @if(Data.Services.Count() == 0)
            {
                <h5>Đang cập nhật...</h5>
            }
            @foreach (var item in Data.Services.EmptyIfNull())
            {
                <div class="col-lg-4 col-sm-6">
                    <div class="item-single text-center mb-30">
                        <div class="icon">
                            <img src="@item.ImageUrl" alt="image">
                        </div>
                        <h3>@item.Title</h3>
                        <p>@item.Summary</p>
                    </div>
                </div>
            }            
           
        </div>
        <div class="pagination justify-content-center @(Data.Services.Count() == 0 ? "d-none" : "")">
            @if (Data.TotalPages >= 2)
            {
                <a href="/@Data.CategoryPath?page=@(Data.CurrentPage - 1)" class="page-numbers"><i class="fas fa-angle-left"></i></a>
            }
            @for (int idx = 1; idx <= Data.TotalPages; idx++)
            {
                <a href="/@Data.CategoryPath?page=@(idx)">
                    <span class="page-numbers @(Data.CurrentPage == idx ? "current" : "")" aria-current="page">@idx</span>
                </a>
            }
            @if (Data.CurrentPage < Data.TotalPages)
            {
                <a href="/@Data.CategoryPath?page=@(Data.CurrentPage + 1)" class="page-numbers"><i class="fas fa-angle-right"></i></a>
            }
        </div>
    </div>
</section>
<!-- End Services Area -->